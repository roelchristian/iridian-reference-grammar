% !Mode:: "TeX:UTF-8"
% encoding:					UTF-8
% compiled with:		luatex
\documentclass[10pt]{scrbook}
\areaset[0.50in]{4.5in}{8in}
% Load packages used

\input{./preamble/common-packages.tex}


%% PACKAGES USED

%% Page layout and encoding
\usepackage[paperwidth=6in,paperheight=9in]{geometry}

\geometry {
    verbose,
    tmargin  =1.1in,
    bmargin  =1.1in,
    lmargin  =0.7in,
    rmargin  =0.7in,
}


%% PACKAGES USED

%% Page layout and encoding

%% Fonts

%\usepackage[oldstylenums]{kpfonts}
\usepackage{ifluatex}
\ifluatex
  \usepackage{fontspec}
  \defaultfontfeatures{Ligatures=TeX,Numbers=Lining}
  %\defaultfontfeatures{Ligatures=TeXNumbers=OldStyle}% ,Scale=MatchLowercase} bug in current Biolinum
  \setmainfont{SourceSansPro}
  \setsansfont{SourceSansPro}
  \newfontfamily\CardoSmallCaps
  [Ligatures={NoRequired, NoCommon, NoContextual},
  Letters={UppercaseSmallCaps,SmallCaps}]
  {SourceSansPro}
\else
  \usepackage[utf8]{inputenc}
  \usepackage[T1]{fontenc}
  \usepackage{kpfonts}
  \usepackage{textgreek}
\fi



%\usepackage{savetrees} % for drafts
\usepackage{microtype}

\usepackage{float}
\doublehyphendemerits=1000000000
\widowpenalty=10000
\clubpenalty=10000
\brokenpenalty=10000


%% Lingustics packages
\usepackage{tipa}
\usepackage{expex}

\gathertags

% Third level examples in expex
% http://tex.stackexchange.com/a/77941
\def\beginsubsub{%
\par
\begingroup
\advance\leftskip by 2em
\def\b##1{\par\leavevmode\llap{\hbox to 2em{##1\hfil}}\ignorespaces}}
\def\endsubsub{\par\endgroup}

\usepackage[russian,english]{babel}
\usepackage[german=guillemets]{csquotes}

\usepackage{graphics,graphicx,amsmath,amssymb}
%% Tables and Graphics
\usepackage[justification=raggedright,labelfont=sc,font={sf,footnotesize},labelsep=quad]{caption}
\captionsetup{justification=raggedright,singlelinecheck=false}
\usepackage{longtable}
\usepackage{minitoc}
\usepackage{afterpage}
\usepackage{xcolor,colortbl}
\usepackage{fancyhdr,textcase}
\usepackage{siunitx,tabularx,ragged2e,booktabs,tabu,multicol}
\usepackage{gensymb}
\usepackage{titlesec}
\usepackage{etoolbox}
\usepackage{multirow}
\usepackage{enumitem}
\usepackage{metalogo}
\usepackage[british]{datetime2}


\setlist[enumerate]{leftmargin=*}
\setlist[itemize]{leftmargin=*}


%% to draw linguistic trees
\usepackage{tikz}
\usepackage[linguistics]{forest}
\usetikzlibrary{positioning}
\usetikzlibrary{tikzmark}
\forestset{
sn edges/.style={for tree={parent anchor=south, child anchor=north}}}

%% Indexing and Cross-referencing
\usepackage{imakeidx}
\usepackage[font=footnotesize]{idxlayout}
\usepackage[hidelinks,unicode]{hyperref} % for final copy
%\usepackage[unicode]{hyperref} % for drafts
\usepackage{url}
\urlstyle{same}


% fancy footnotes
\usepackage[norule,splitrule]{footmisc}

\RequirePackage[authordate,backend=biber]{biblatex-chicago}
\DeclareFieldFormat[article]{title}{\mkbibquote{#1}} % make article titles in quotes
\DeclareFieldFormat[thesis]{title}{\mkbibemph{#1}} % make theses italics
\addbibresource{./bibliography/bibliography.bib}
\setlength\bibitemsep{0.4\itemsep}
\renewcommand*{\bibfont}{\small}



\renewcommand*{\postnotedelim}{\addcolon\addspace}
\DeclareFieldFormat{postnote}{#1}
\DeclareFieldFormat{multipostnote}{#1}



\makeindex
\setcounter{secnumdepth}{2}
\setcounter{tocdepth}{2}


%% CUSTOM COMMANDS
\newcommand{\cscaps}{\CardoSmallCaps}
\newcommand{\zz}{\textctz}								% voiced palatal sibilant
\newcommand{\bt}[1]{/\textipa{#1}/}				% broad transcription
\newcommand{\nt}[1]{[\textipa{#1}]}				% narrow transcription
\newcommand{\sx}[1]{\textsuperscript{#1}}	% superscript phoneme
\newcommand{\mk}[1]{\textsc{#1}}					% glossing abbreviation
\newcommand{\dpu}{\textsubarch{u}}
\newcommand{\nn}{\textltailn}							% palatal n
\newcommand{\jjg}{\textbardotlessj}				% voiced palatal stop
\newcommand{\llt}{\textltilde}						% dark l
\newcommand{\llb}{\textbeltl}							% nahuatl l
\newcommand{\jn}[1]{\texttoptiebar{#1}}		% top tie for affricates
\newcommand{\tsa}[1]{\textsubarch{#1}}
\newcommand{\glot}{\textglotstop}					% glottal stop
\newcommand{\tss}[1]{\textsubscript{#1}}
\newcommand{\nf}[1]{\normalfont {#1}}
\newcommand{\tsup}[1]{\textsuperscript{#1}}
\newcommand{\ird}[1]{\textit{#1}}					% text in Iridian
\newcommand{\foreign}[1]{\textit{#1}}         % text in another language
%\newcommand{\ird}[1]{\colorbox{pink}{\textit{#1}}} % for drafts        % text in Iridian
\newcommand{\dto}{o\textsubarch{u}}				% ou diphthong
\newcommand{\dte}{e\textsubarch{I}}				% ei diphthong
\newcommand{\rec}[1]{*\textit{#1}}				% reconstruction in Old Iridian
\newcommand{\trsl}[1]{`#1'}								% translation in quotes
\newcommand{\rrr}{\textinvscr}						% uvular r
\newcommand{\irdp}[2]{\ird{#1}, \trsl{#2}}
\newcommand{\irdU}[1]{#1} % non-italicised Iridian text
\newcommand{\ttla}[1]{`#1'}								% title of an article, short story setcounter
\newcommand{\ttlb}[1]{\emph{#1}}					% title of a book
\newcommand{\irdt}[3]{\textit{#1} \nt{#2}, \trsl{#3}}
\newcommand{\orth}[1]{$\langle$#1$\rangle$}
\newcommand{\phon}[3]{\ird{#1} [#2] \trsl{#3}}
\newcommand{\su}[1]{$_{#1}$}
\newcommand{\SubjI}{\Subj{}.\Ipf{}}
\newcommand{\SubjP}{\Subj{}.\Pf{}}






% TODO: Rewrite instances of this command and delete
\newcommand{\asp}[1]{{#1}\textsuperscript{h}}

%% Set block quotes to font size \small

\expandafter\def\expandafter\quote\expandafter{\quote\small}

%% Formatting of linguistic glosses

\lingset{everygla=,everyglb=\footnotesize,everyglft=\footnotesize,aboveexskip=5pt,aboveglftskip=0pt,belowexskip=5pt}


% Possessive citations like "Doe's (1992)"
% From C Becker
% https://tex.stackexchange.com/a/307461
\DeclareNameFormat{labelname:poss}{% Based on labelname from biblatex.def
  \nameparts{#1}% Not needed if using Biblatex 3.4
  \ifcase\value{uniquename}%
    \usebibmacro{name:family}{\namepartfamily}{\namepartgiven}{\namepartprefix}{\namepartsuffix}%
  \or
    \ifuseprefix
      {\usebibmacro{name:first-last}{\namepartfamily}{\namepartgiveni}{\namepartprefix}{\namepartsuffixi}}
      {\usebibmacro{name:first-last}{\namepartfamily}{\namepartgiveni}{\namepartprefixi}{\namepartsuffixi}}%
  \or
    \usebibmacro{name:first-last}{\namepartfamily}{\namepartgiven}{\namepartprefix}{\namepartsuffix}%
  \fi
  \usebibmacro{name:andothers}%
  \ifnumequal{\value{listcount}}{\value{liststop}}{'s}{}}
\DeclareFieldFormat{shorthand:poss}{%
  \ifnameundef{labelname}{#1's}{#1}}
\DeclareFieldFormat{citetitle:poss}{\mkbibemph{#1}'s}
\DeclareFieldFormat{label:poss}{#1's}
\newrobustcmd*{\posscitealias}{%
  \AtNextCite{%
    \DeclareNameAlias{labelname}{labelname:poss}%
    \DeclareFieldAlias{shorthand}{shorthand:poss}%
    \DeclareFieldAlias{citetitle}{citetitle:poss}%
    \DeclareFieldAlias{label}{label:poss}}}
\newrobustcmd*{\posscite}{%
  \posscitealias%
  \textcite}
\newrobustcmd*{\Posscite}{\bibsentence\posscite}
\newrobustcmd*{\posscites}{%
  \posscitealias%
  \textcites}

%%Formatting of section headings


\makeatletter
\def\thickhrulefill{\leavevmode \leaders \hrule height 1ex \hfill \kern \z@}
\def\@makechapterhead#1{%
	\vspace*{10\p@}%
	{\parindent \z@ \centering \reset@font
		{\Large \CardoSmallCaps \thechapter}
		\par
		\vspace*{1\p@}%
		\interlinepenalty\@M
		\setlength{\arrayrulewidth}{2pt}
		\par\noindent
		\rule{24pt}{2pt}
		\\
		\begin{tabular}{@{\qquad}c@{\qquad}}

			\\
			{\LARGE \CardoSmallCaps \MakeLowercase{#1}\par\nobreak} \\
			\\

		\end{tabular}
		\vskip 90\p@
}}
\def\@makeschapterhead#1{%
	\vspace*{\p@}%
	{\parindent \z@ \centering \reset@font
		{\Large \CardoSmallCaps \vphantom{\thechapter}}
		\par\nobreak
		\vspace*{15\p@}%
		\interlinepenalty\@M
		\setlength{\arrayrulewidth}{2pt}
		\par\noindent
		\rule{24pt}{2pt}
		\\
		\begin{tabular}{@{\qquad}c@{\qquad}}

			\\
			{\LARGE \CardoSmallCaps \MakeLowercase{#1}\par\nobreak} \\
			\\

		\end{tabular}
		\vskip 80\p@
}}


%% Formatting of sections
\titleformat{\section}
{\large}{\thesection}{1em}{\large}
\titlespacing*{\section}
{0pt}{3ex plus 1ex minus .2ex}{4pt}

%% Formatting of subsections
\titleformat{\subsection}[hang]
{}{\thesubsection}{1em}{\CardoSmallCaps\lowercase}
\titlespacing*{\subsection}
{0pt}{3ex plus 1ex minus .2ex}{4pt}


%% Formatting of subsubsections
\titleformat{\subsubsection}
{\small}{\thesubsubsection}{1em}{\small\itshape}

\usepackage{titletoc}
\input{./preamble/toc.tex}

%% Formatting of page headers

\renewcommand{\chapterpagestyle}{empty}%The first page in each chapter won't have any heading or footer, especially no page number
\pagestyle{fancy}
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{#1}}
\renewcommand{\headrulewidth}{0pt}
\fancyhf{}
\fancyhead[RE]{{{\CardoSmallCaps\small\MakeLowercase{\leftmark}}}\hfill{\small\thepage}}
\fancyhead[LO]{{\small\thepage}\hfill{\CardoSmallCaps\small\MakeLowercase{\rightmark}}}
\cfoot{}


% Glosses in footnotes
\newcounter{fnexno}
\setcounter{fnexno}{1}
\definelingstyle{fnex}{
% exno=\footnotesize\roman{fnexno}\stepcounter{fnexno},
  exno=\roman{fnexno}\stepcounter{fnexno},
  everyex=\footnotesize,
  numoffset=\footnotemargin,
  aboveexskip=2ex,
  belowglpreambleskip=-1ex,
  interpartskip=0.5ex,
  aboveglftskip=-1ex,
  belowexskip=0ex,
}

%% Custom column types
\newcolumntype{Y}{>{\RaggedRight\arraybackslash}X}
\newcolumntype{Z}{>{\RaggedRight\everypar{\hangindent=1em}\arraybackslash}X}
\newcolumntype{M}{>{\centering\arraybackslash}X}
\newcolumntype{T}[1]{S[table-format=#1]}

% Restart numbering each chapter
\pretocmd{\chapter}{\excnt=1}{}{}

\input{./preamble/leipzig.tex}

\begin{document}

\author{}
\title{A Reference Grammar of the Iridian Language}
\date{}

\frontmatter


\include{./preamble/titlepage}

\include{./preamble/colophon}				% Colophon

\tableofcontents

\cleardoublepage

\listoftables
\addcontentsline{toc}{chapter}{List of Tables}

\listoffigures
\addcontentsline{toc}{chapter}{List of Figures}


\include{./chapters/00-01-preface}				% Preface
\include{./chapters/00-02-abbreviations}					% Abbreviations Used

\mainmatter

\include{./chapters/01-overview}
\include{./chapters/02-phonology}
\include{./chapters/03-verbal-morphology}			
\include{./chapters/04-nominal-morphology} 
\include{./chapters/05-minor-word-classes}			
\include{./chapters/06-derivational-morphology} 
\include{./chapters/07-clause-structure}
\include{./chapters/08-semantics-and-usage}


\appendix
\part*{Appendices}
\include{./chapters/appx-01-spoken-iridian}
\include{./chapters/appx-02-dialects}
\include{./chapters/appx-03-lexicon}
\include{./chapters/appx-04-sample-texts}
\include{./chapters/appx-05-brief-history}

\cleardoublepage
\nocite{*}
\printbibliography
\addcontentsline{toc}{chapter}{Bibliography}
\markboth{Bibliography}{Bibliography}

\cleardoublepage
\printindex
\addcontentsline{toc}{chapter}{Index}
\markboth{Index}{Index}

\end{document}
